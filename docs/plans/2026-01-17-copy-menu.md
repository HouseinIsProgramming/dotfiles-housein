# Copy Menu Feature Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Add a copy menu (press `c`) that lets users copy file name, directory, absolute path, or relative path to clipboard.

**Architecture:** Add `CopyMode` enum to track menu state. When `c` is pressed, show overlay menu with options 1-4. On selection, copy to clipboard via `pbcopy` (macOS) and exit copy mode. Press `Esc` to cancel.

**Tech Stack:** Rust, ratatui (popup rendering), pbcopy (clipboard)

---

### Task 1: Add CopyMode State to App

**Files:**
- Modify: `~/.config/scripts/tmux-sidebar/src/app.rs`

**Step 1: Add CopyMode enum and field**

Add at top of file after imports:

```rust
#[derive(Debug, Clone, Copy, PartialEq)]
pub enum CopyMode {
    None,
    Selecting,
}
```

Add field to `App` struct (after `should_quit`):

```rust
pub copy_mode: CopyMode,
```

**Step 2: Initialize in App::new()**

Add to the `Self { ... }` initializer:

```rust
copy_mode: CopyMode::None,
```

**Step 3: Add copy methods**

Add these methods to `impl App`:

```rust
pub fn enter_copy_mode(&mut self) {
    if self.selected_node().is_some() {
        self.copy_mode = CopyMode::Selecting;
    }
}

pub fn exit_copy_mode(&mut self) {
    self.copy_mode = CopyMode::None;
}

pub fn copy_selection(&mut self, option: u8) {
    let Some(node) = self.selected_node() else {
        self.exit_copy_mode();
        return;
    };

    let text = match option {
        1 => node.name.clone(),                                    // File name
        2 => node.path.parent()                                    // Directory
            .map(|p| p.to_string_lossy().to_string())
            .unwrap_or_default(),
        3 => node.path.to_string_lossy().to_string(),             // Absolute path
        4 => node.path.strip_prefix(&self.root_path)              // Relative path
            .map(|p| p.to_string_lossy().to_string())
            .unwrap_or_else(|_| node.path.to_string_lossy().to_string()),
        _ => {
            self.exit_copy_mode();
            return;
        }
    };

    // Copy to clipboard using pbcopy (macOS)
    if let Err(e) = std::process::Command::new("pbcopy")
        .stdin(std::process::Stdio::piped())
        .spawn()
        .and_then(|mut child| {
            use std::io::Write;
            if let Some(stdin) = child.stdin.as_mut() {
                stdin.write_all(text.as_bytes())?;
            }
            child.wait()
        })
    {
        eprintln!("Failed to copy: {}", e);
    }

    self.exit_copy_mode();
}
```

**Step 4: Build to verify**

Run: `cd ~/.config/scripts/tmux-sidebar && cargo build --release`
Expected: Compiles with warnings about unused enum/methods

**Step 5: Commit**

```bash
git add ~/.config/scripts/tmux-sidebar/src/app.rs
git commit -m "feat(tmux-sidebar): add copy mode state and methods"
```

---

### Task 2: Add Copy Menu UI Rendering

**Files:**
- Modify: `~/.config/scripts/tmux-sidebar/src/ui.rs`

**Step 1: Update imports**

Add to imports:

```rust
use ratatui::layout::{Constraint, Layout, Rect};
use ratatui::widgets::{Clear, Paragraph};
use crate::app::CopyMode;
```

**Step 2: Add render_copy_menu function**

Add after the `render` function:

```rust
fn render_copy_menu(frame: &mut Frame, area: Rect) {
    // Center the popup
    let popup_width = 30;
    let popup_height = 6;
    let x = (area.width.saturating_sub(popup_width)) / 2;
    let y = (area.height.saturating_sub(popup_height)) / 2;
    let popup_area = Rect::new(x, y, popup_width, popup_height);

    // Clear the area
    frame.render_widget(Clear, popup_area);

    let menu_text = vec![
        Line::from("Copy:"),
        Line::from(""),
        Line::from("  1. File name"),
        Line::from("  2. Directory"),
        Line::from("  3. Absolute path"),
        Line::from("  4. Relative path"),
    ];

    let menu = Paragraph::new(menu_text)
        .block(Block::default()
            .borders(Borders::ALL)
            .border_style(Style::default().fg(Color::Cyan))
            .title("Copy"));

    frame.render_widget(menu, popup_area);
}
```

**Step 3: Update render function to show menu**

At the end of the `render` function, before the closing brace, add:

```rust
    // Show copy menu if in copy mode
    if app.copy_mode == CopyMode::Selecting {
        render_copy_menu(frame, area);
    }
```

**Step 4: Build to verify**

Run: `cd ~/.config/scripts/tmux-sidebar && cargo build --release`
Expected: Compiles successfully

**Step 5: Commit**

```bash
git add ~/.config/scripts/tmux-sidebar/src/ui.rs
git commit -m "feat(tmux-sidebar): add copy menu popup rendering"
```

---

### Task 3: Add Key Bindings for Copy Mode

**Files:**
- Modify: `~/.config/scripts/tmux-sidebar/src/main.rs`

**Step 1: Import CopyMode**

Add to imports:

```rust
use app::CopyMode;
```

**Step 2: Update key handling**

Replace the key handling match block (lines 98-119) with:

```rust
                match (key.code, key.modifiers) {
                    // Copy mode handling
                    _ if app.copy_mode == CopyMode::Selecting => {
                        match key.code {
                            KeyCode::Char('1') => app.copy_selection(1),
                            KeyCode::Char('2') => app.copy_selection(2),
                            KeyCode::Char('3') => app.copy_selection(3),
                            KeyCode::Char('4') => app.copy_selection(4),
                            KeyCode::Esc | KeyCode::Char('q') | KeyCode::Char('c') => app.exit_copy_mode(),
                            _ => {}
                        }
                    }
                    // Normal mode
                    (KeyCode::Char('q'), _) | (KeyCode::Esc, _) => {
                        app.should_quit = true;
                    }
                    (KeyCode::Char('c'), _) => app.enter_copy_mode(),
                    (KeyCode::Char('j'), _) | (KeyCode::Down, _) => app.move_down(),
                    (KeyCode::Char('k'), _) | (KeyCode::Up, _) => app.move_up(),
                    (KeyCode::Char('l'), _) | (KeyCode::Right, _) | (KeyCode::Enter, _) => {
                        if app.selected_node().map(|n| !n.is_dir).unwrap_or(false) {
                            app.open_selected();
                        } else {
                            app.expand_or_enter();
                        }
                    }
                    (KeyCode::Char('h'), _) | (KeyCode::Left, _) => app.collapse_or_parent(),
                    (KeyCode::Char('H'), KeyModifiers::SHIFT) => app.go_to_root(),
                    (KeyCode::Char('r'), _) => app.reload(None),
                    (KeyCode::Char('g'), _) => app.cursor = 0,
                    (KeyCode::Char('G'), KeyModifiers::SHIFT) => {
                        app.cursor = app.visible_items().len().saturating_sub(1);
                    }
                    _ => {}
                }
```

**Step 3: Build and test**

Run: `cd ~/.config/scripts/tmux-sidebar && cargo build --release`
Expected: Compiles successfully

**Step 4: Commit**

```bash
git add ~/.config/scripts/tmux-sidebar/src/main.rs
git commit -m "feat(tmux-sidebar): add copy mode key bindings"
```

---

## Summary

| Key | Action |
|-----|--------|
| `c` | Open copy menu |
| `1` | Copy file name |
| `2` | Copy directory |
| `3` | Copy absolute path |
| `4` | Copy relative path |
| `Esc` | Cancel copy menu |

**Copy options:**
- **File name**: `main.rs`
- **Directory**: `/Users/housien/.config/scripts/tmux-sidebar/src`
- **Absolute path**: `/Users/housien/.config/scripts/tmux-sidebar/src/main.rs`
- **Relative path**: `src/main.rs` (from project root)
