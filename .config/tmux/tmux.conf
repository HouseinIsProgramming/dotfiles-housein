set -s escape-time 0
set-option -sa terminal-features ',xterm-256color:RGB'
set-option -g allow-passthrough on
set -g set-clipboard on

# Enable extended keys for Ctrl+punctuation (Ctrl+,, Ctrl+. etc.)
set -s extended-keys on
set -as terminal-features 'xterm*:extkeys'
unbind C-b
set-option -g prefix C-s
bind-key C-s send-prefix
bind r source-file ~/.config/tmux/tmux.conf \; display-message "Config reloaded..."
bind R run-shell "~/.zshrc"; display-message "Config reloaded..."
set -g base-index 1

# set-option remain-on-exit on
set -g renumber-windows on   # renumber all windows when any window is closed
set -g escape-time 0         # zero-out escape time delay

# Window naming: use pane_title, append -N suffix if directory ends with -NUMBER
set -g automatic-rename-format '#{?#{m/r:-[0-9]+$,#{b:pane_current_path}},#{pane_title}#{s/.*(-[0-9]+)$/\1/:#{b:pane_current_path}},#{pane_title}}'
set-window-option -g mode-keys vi
set -g mode-keys vi

# Mouse selection copies but doesn't exit copy-mode
bind-key -T copy-mode-vi MouseDragEnd1Pane send-keys -X copy-selection

# Open file:line - triggers thumbs hints, selection opens in nvim
bind-key C-n thumbs-pick
# C-n N - jump to first nvim window
bind-key -T prefix N run-shell "tmux select-window -t :nvim 2>/dev/null || tmux select-window -t :\$(tmux list-windows -F '#{window_index} #{window_name}' | grep -i nvim | head -1 | cut -d' ' -f1)"

# style
set -g pane-border-lines heavy
set -g pane-border-status off
set -g pane-border-format '#{?pane_active,#[fill=colour237 bg=colour237 fg=colour4 bold],#[fill=colour235 bg=colour235 fg=colour8]} #P: #{pane_title} '
set-hook -g window-layout-changed "if-shell -F '#{e|>:#{window_panes},1}' 'set pane-border-status top' 'set pane-border-status off'"
set -g pane-active-border-style 'fg=colour4'
set -g pane-border-style 'fg=colour8'
set -g status-position top
set -g status-justify absolute-centre
set -g status-style 'fg=color8 bg=default'
set -g status-left '#S'
set -g status-left-style 'fg=color2'
set -g status-right-length 0
set -g status-left-length 100
setw -g window-status-current-style 'fg=colour4 bg=default bold'
setw -g window-status-current-format '#I:#W '
setw -g window-status-style 'fg=color8'
set -g status-interval 5
# set -g status-right '#(timew | awk "/^ *Total/ {print \$NF}")  #[bg=green,fg=black,bold]#(timew | awk "/^ *Tracking/ {print \$NF}")#[bg=default]#{?client_prefix,#[fg=cyan] (■‿■⌐),#[fg=grey,bg=default] (•‿• )}'
set -g status-right '#(timew | awk "/^ *Total/ {print \$NF}") #[bg=green,fg=black,bold]#(timew | awk "/^ *Tracking/ {print \" \" \$NF \" \"}")#[bg=default]#{?client_prefix,#[fg=cyan] (■‿■⌐),#[fg=grey,bg=default] (•‿• )}'
setw -g mouse on

# vim-like pane switching (prefix + C-hjkl)
unbind -n C-h
unbind -n C-j
unbind -n C-k
unbind -n C-l
bind -r ^ last-window
bind C-k select-pane -U
bind C-j select-pane -D
bind C-h select-pane -L
bind C-l select-pane -R

# better new pane
bind c new-window -c "#{pane_current_path}"

# Scripts that are baked into tmux
bind g run-shell "tmux new-window -c '#{pane_current_path}' 'cd $(git -C #{pane_current_path} rev-parse --show-toplevel) && lazygit'"
bind f run-shell "tmux neww ~/.config/scripts/tmux-sessionizer.sh"
bind t run-shell "tmux neww ~/.config/scripts/timetrack.sh"
bind o neww -S -n "TASKS" "nvim /Users/housien/Documents/Obsidian/denseVault/W-Tasks.md"
bind O neww -S -n "SCRATCHPAD" "nvim /users/housien/documents/obsidian/densevault/Scratchpad.md"

# resize panes (prefix + shift + hjkl)
bind -r H resize-pane -L 5
bind -r L resize-pane -R 5
bind -r J resize-pane -D 5
bind -r K resize-pane -U 5

# switch between two most recently used sessions
bind ` switch-client -l
# switch between two most recently used windows
bind-key l last-window


# search sessions
bind C-e display-popup -E "\
    tmux list-sessions -F '#{?session_attached,,#{session_name}}' |\
    sed '/^$/d' |\
    fzf --reverse --header jump-to-session |\
    xargs tmux switch-client -t"

# search windows in current session
bind C-f display-popup -E "\
    tmux list-windows -F '#{window_index} #{window_name}' |\
    sed '/^$/d' |\
    fzf --reverse --header jump-to-window |\
    cut -d ' ' -f 1 |\
    xargs tmux select-window -t"

# floating scratch terminal (toggle) - uses nested session for proper keybinding support
bind C-o if-shell -F '#{m:_popup_*,#{session_name}}' 'detach-client' 'display-popup -E -w 80% -h 80% "~/.config/scripts/tmux-popup.sh"'

# bind-key -r P run-shell "cd ~/Documents/GitHub"
# bind-key -r D run-shell "cd ~/.config"
# bind-key -r H run-shell "cd ~"
# bind-key -r N run-shell "~/.config/scripts/tmux-sessionizer.sh ~/documents/notes"
# bind-key -r J run-shell "~/.config/scripts/tmux-sessionizer.sh ~/Journal"
# bind-key O run-shell "tmux neww ~/.config/scripts/op.sh"
# bind-key o run-shell "tmux neww ~/.config/scripts/oa.sh"
# rename pane (like , for windows)
bind < command-prompt -p "pane title:" "select-pane -T '%%'"
bind-key b set-option status

# Window navigation: first and last
bind a select-window -t :1
bind e run-shell 'tmux select-window -t :$(tmux list-windows -F "##{window_index}" | tail -1)'
# Toggle file sidebar
bind E run-shell "~/.config/scripts/tmux-sidebar-toggle.sh #{pane_id}"


# List of plugins
set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'fcsonline/tmux-thumbs'
set -g @thumbs-reverse enabled
set -g @thumbs-command 'echo -n {} | pbcopy'
# Shift + hint → open in nvim
set -g @thumbs-upcase-command 'tmux new-window ~/.config/scripts/open-in-nvim {}'
# Custom regex to match file paths with :line numbers
set -g @thumbs-regexp-1 '[\w./~\[\]-]+\.\w+:\d+'
# Match file paths without line numbers (includes brackets for Next.js routes)
set -g @thumbs-regexp-2 '[\w./~\[\]-]+\.\w+'

# run-shell ~/.tmux/plugins/tmux-thumbs/tmux-thumbs.tmux
run '~/.config/tmux/plugins/tpm/tpm'
